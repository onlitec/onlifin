# ü§ñ PROMPT MASTER: Implementa√ß√£o de Sistema de Contas para Pessoas Jur√≠dicas - OnliFin

## üìã CONTEXTO

Voc√™ √© um desenvolvedor full-stack especializado em React, TypeScript, Supabase e PostgreSQL. Seu objetivo √© implementar um sistema completo de gest√£o financeira para Pessoas Jur√≠dicas (PJ) na plataforma OnliFin, que atualmente suporta apenas contas de Pessoa F√≠sica (PF).

### Plataforma Atual
- **Frontend**: React + TypeScript + Vite
- **Backend**: Supabase (PostgreSQL)
- **UI**: shadcn/ui + Tailwind CSS
- **Autentica√ß√£o**: Supabase Auth
- **Deploy**: Docker + GitHub Actions

### Reposit√≥rio
- GitHub: https://github.com/onlitec/onlifin
- Branch principal: `main`
- Nova branch de trabalho: `feature/pj-accounts`

---

## üéØ OBJETIVO PRINCIPAL

Implementar um sistema que permita:
1. ‚úÖ Gest√£o de m√∫ltiplas empresas (CNPJ) separadas por usu√°rio
2. ‚úÖ Isolamento completo de dados entre PF e PJ
3. ‚úÖ Isolamento de dados entre diferentes empresas PJ
4. ‚úÖ Visualiza√ß√£o consolidada de todas as empresas na mesma plataforma
5. ‚úÖ Relat√≥rios, gr√°ficos e an√°lises comparativas multi-empresa
6. ‚úÖ Transi√ß√µes entre contas PF e PJ sem conflitos
7. ‚úÖ Manuten√ß√£o de todas as funcionalidades existentes para PF

---

## üèóÔ∏è ARQUITETURA

### Estrat√©gia de Multi-Tenancy
**Modelo Escolhido**: Row-Level Security (RLS) com Tenant Isolation

**Justificativa**:
- M√°ximo isolamento de dados
- Seguran√ßa nativa do PostgreSQL
- Performance otimizada com √≠ndices
- Escalabilidade horizontal
- Auditoria completa

### Princ√≠pios de Design
1. **Separa√ß√£o Clara**: PF e PJ s√£o tipos de conta distintos
2. **Flexibilidade**: Um usu√°rio pode ter conta PF E m√∫ltiplas PJ
3. **Isolamento**: Dados de cada empresa s√£o completamente separados
4. **Consolida√ß√£o**: Relat√≥rios podem agregar dados de m√∫ltiplas empresas
5. **Rastreabilidade**: Todas as opera√ß√µes s√£o auditadas

---

## üìä MODELO DE DADOS

### Tabelas Principais

#### 1. account_types
```sql
CREATE TABLE account_types (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  code VARCHAR(2) UNIQUE NOT NULL CHECK (code IN ('PF', 'PJ')),
  name VARCHAR(50) NOT NULL,
  description TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);
```

#### 2. user_profiles (ESTENDIDA)
```sql
-- Adicionar campos:
ALTER TABLE user_profiles ADD COLUMN account_type_id UUID REFERENCES account_types(id);
ALTER TABLE user_profiles ADD COLUMN cpf VARCHAR(14) UNIQUE;
ALTER TABLE user_profiles ADD COLUMN birth_date DATE;
ALTER TABLE user_profiles ADD COLUMN phone VARCHAR(20);
ALTER TABLE user_profiles ADD COLUMN default_company_id UUID;

-- Constraint para garantir CPF em contas PF
ALTER TABLE user_profiles ADD CONSTRAINT valid_pf_data CHECK (
  (account_type_id = (SELECT id FROM account_types WHERE code = 'PF') AND cpf IS NOT NULL)
  OR account_type_id != (SELECT id FROM account_types WHERE code = 'PF')
);
```

#### 3. companies (NOVA)
```sql
CREATE TABLE companies (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES user_profiles(id) ON DELETE CASCADE NOT NULL,
  
  -- Dados Principais
  cnpj VARCHAR(18) UNIQUE NOT NULL,
  razao_social VARCHAR(255) NOT NULL,
  nome_fantasia VARCHAR(255),
  inscricao_estadual VARCHAR(50),
  inscricao_municipal VARCHAR(50),
  
  -- Endere√ßo
  cep VARCHAR(10),
  logradouro VARCHAR(255),
  numero VARCHAR(20),
  complemento VARCHAR(100),
  bairro VARCHAR(100),
  cidade VARCHAR(100),
  uf VARCHAR(2),
  
  -- Contato
  email VARCHAR(255),
  phone VARCHAR(20),
  website VARCHAR(255),
  
  -- Classifica√ß√£o
  porte VARCHAR(20) CHECK (porte IN ('MEI', 'ME', 'EPP', 'MEDIA', 'GRANDE')),
  regime_tributario VARCHAR(30) CHECK (regime_tributario IN ('SIMPLES', 'LUCRO_PRESUMIDO', 'LUCRO_REAL')),
  
  -- Dados Banc√°rios Padr√£o
  banco_padrao VARCHAR(100),
  agencia_padrao VARCHAR(20),
  conta_padrao VARCHAR(30),
  
  -- Status
  is_active BOOLEAN DEFAULT true,
  is_default BOOLEAN DEFAULT false,
  
  -- Configura√ß√µes
  settings JSONB DEFAULT '{}'::jsonb,
  
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW()),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW()),
  
  CONSTRAINT unique_default_per_user UNIQUE (user_id, is_default) WHERE is_default = true
);
```

#### 4. Tabelas Existentes (ADAPTADAS)

Todas as tabelas existentes (`bank_accounts`, `categories`, `transactions`, `financial_goals`, `budgets`) devem ser estendidas com:

```sql
ALTER TABLE [table_name] ADD COLUMN company_id UUID REFERENCES companies(id) ON DELETE CASCADE;

-- Constraint para garantir consist√™ncia
ALTER TABLE [table_name] ADD CONSTRAINT pf_no_company CHECK (
  (company_id IS NULL AND user_id IN (SELECT id FROM user_profiles WHERE account_type_id = (SELECT id FROM account_types WHERE code = 'PF')))
  OR company_id IS NOT NULL
);
```

### Row-Level Security (RLS)

**CR√çTICO**: Todas as tabelas DEVEM ter RLS habilitado com policies que garantam:

```sql
-- Exemplo para transactions
ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own transactions"
  ON transactions FOR SELECT
  USING (
    auth.uid() = user_id AND
    (company_id IS NULL OR company_id IN (SELECT id FROM companies WHERE user_id = auth.uid()))
  );

CREATE POLICY "Users can insert own transactions"
  ON transactions FOR INSERT
  WITH CHECK (
    auth.uid() = user_id AND
    (company_id IS NULL OR company_id IN (SELECT id FROM companies WHERE user_id = auth.uid()))
  );

-- Repetir para UPDATE e DELETE
```

### Functions Essenciais

#### Valida√ß√£o de CNPJ
```sql
CREATE OR REPLACE FUNCTION validate_cnpj(cnpj_input VARCHAR)
RETURNS BOOLEAN AS $$
DECLARE
  cnpj VARCHAR(14);
  sum1 INTEGER := 0;
  sum2 INTEGER := 0;
  digit1 INTEGER;
  digit2 INTEGER;
  multiplier INTEGER;
BEGIN
  cnpj := REGEXP_REPLACE(cnpj_input, '[^0-9]', '', 'g');
  
  IF LENGTH(cnpj) != 14 THEN
    RETURN FALSE;
  END IF;
  
  IF cnpj IN ('00000000000000', '11111111111111', '22222222222222', 
              '33333333333333', '44444444444444', '55555555555555',
              '66666666666666', '77777777777777', '88888888888888', 
              '99999999999999') THEN
    RETURN FALSE;
  END IF;
  
  -- C√°lculo dos d√≠gitos verificadores
  FOR i IN 1..12 LOOP
    multiplier := CASE WHEN i <= 4 THEN 6 - i ELSE 14 - i END;
    sum1 := sum1 + (CAST(SUBSTRING(cnpj FROM i FOR 1) AS INTEGER) * multiplier);
  END LOOP;
  
  digit1 := CASE WHEN (sum1 % 11) < 2 THEN 0 ELSE 11 - (sum1 % 11) END;
  
  FOR i IN 1..13 LOOP
    multiplier := CASE WHEN i <= 5 THEN 7 - i ELSE 15 - i END;
    sum2 := sum2 + (CAST(SUBSTRING(cnpj FROM i FOR 1) AS INTEGER) * multiplier);
  END LOOP;
  
  digit2 := CASE WHEN (sum2 % 11) < 2 THEN 0 ELSE 11 - (sum2 % 11) END;
  
  RETURN (digit1 = CAST(SUBSTRING(cnpj FROM 13 FOR 1) AS INTEGER) AND
          digit2 = CAST(SUBSTRING(cnpj FROM 14 FOR 1) AS INTEGER));
END;
$$ LANGUAGE plpgsql;

ALTER TABLE companies ADD CONSTRAINT valid_cnpj CHECK (validate_cnpj(cnpj));
```

#### Atualiza√ß√£o de Saldo
```sql
CREATE OR REPLACE FUNCTION calculate_account_balance(account_uuid UUID)
RETURNS DECIMAL AS $$
DECLARE
  total_income DECIMAL;
  total_expense DECIMAL;
  initial_bal DECIMAL;
BEGIN
  SELECT initial_balance INTO initial_bal
  FROM bank_accounts WHERE id = account_uuid;
  
  SELECT COALESCE(SUM(amount), 0) INTO total_income
  FROM transactions
  WHERE account_id = account_uuid AND type = 'income' AND status = 'completed';
  
  SELECT COALESCE(SUM(amount), 0) INTO total_expense
  FROM transactions
  WHERE account_id = account_uuid AND type = 'expense' AND status = 'completed';
  
  RETURN initial_bal + total_income - total_expense;
END;
$$ LANGUAGE plpgsql;
```

#### Auditoria
```sql
CREATE TABLE audit_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES user_profiles(id) NOT NULL,
  company_id UUID REFERENCES companies(id),
  action VARCHAR(50) NOT NULL,
  table_name VARCHAR(100) NOT NULL,
  record_id UUID,
  old_data JSONB,
  new_data JSONB,
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);

CREATE OR REPLACE FUNCTION audit_log_changes()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO audit_logs (user_id, company_id, action, table_name, record_id, old_data, new_data)
  VALUES (
    auth.uid(),
    COALESCE(NEW.company_id, OLD.company_id),
    TG_OP,
    TG_TABLE_NAME,
    COALESCE(NEW.id, OLD.id),
    CASE WHEN TG_OP = 'DELETE' THEN row_to_json(OLD) ELSE NULL END,
    CASE WHEN TG_OP IN ('INSERT', 'UPDATE') THEN row_to_json(NEW) ELSE NULL END
  );
  RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### Views Consolidadas
```sql
CREATE OR REPLACE VIEW v_company_summary AS
SELECT 
  c.id as company_id,
  c.user_id,
  c.razao_social,
  c.nome_fantasia,
  c.cnpj,
  COUNT(DISTINCT ba.id) as total_accounts,
  SUM(ba.current_balance) as total_balance,
  COUNT(DISTINCT t.id) as total_transactions,
  SUM(CASE WHEN t.type = 'income' THEN t.amount ELSE 0 END) as total_income,
  SUM(CASE WHEN t.type = 'expense' THEN t.amount ELSE 0 END) as total_expense
FROM companies c
LEFT JOIN bank_accounts ba ON c.id = ba.company_id
LEFT JOIN transactions t ON c.id = t.company_id
WHERE c.is_active = true
GROUP BY c.id, c.user_id, c.razao_social, c.nome_fantasia, c.cnpj;
```

### √çndices de Performance
```sql
CREATE INDEX idx_companies_user_id ON companies(user_id);
CREATE INDEX idx_companies_cnpj ON companies(cnpj);
CREATE INDEX idx_bank_accounts_company_id ON bank_accounts(company_id);
CREATE INDEX idx_transactions_company_id ON transactions(company_id);
CREATE INDEX idx_transactions_user_company_date ON transactions(user_id, company_id, date DESC);
```

---

## üé® FRONTEND

### 1. Context API para Empresas

**Arquivo**: `src/context/CompanyContext.tsx`

**Responsabilidades**:
- Gerenciar lista de empresas do usu√°rio
- Manter empresa selecionada
- Prover fun√ß√µes CRUD para empresas
- Sincronizar com localStorage

**Interface Principal**:
```typescript
interface CompanyContextType {
  companies: Company[];
  selectedCompany: Company | null;
  isLoadingCompanies: boolean;
  selectCompany: (companyId: string) => void;
  refreshCompanies: () => Promise<void>;
  createCompany: (data: Partial<Company>) => Promise<Company>;
  updateCompany: (id: string, data: Partial<Company>) => Promise<void>;
  deleteCompany: (id: string) => Promise<void>;
}
```

**Funcionalidades Cr√≠ticas**:
1. Carregar empresas ao montar
2. Selecionar empresa padr√£o automaticamente
3. Persistir empresa selecionada em localStorage
4. Sincroniza√ß√£o em tempo real com Supabase Realtime

### 2. Hook de Filtro Multi-Empresa

**Arquivo**: `src/hooks/useMultiCompanyFilter.ts`

**Prop√≥sito**: Facilitar consultas que agregam dados de m√∫ltiplas empresas

**Exemplo de Uso**:
```typescript
const { filterOptions, setFilterOptions, buildSupabaseFilter } = useMultiCompanyFilter();

// Aplicar filtro em query
let query = supabase.from('transactions').select('*');
query = buildSupabaseFilter(query);
const { data } = await query;
```

### 3. Componentes Principais

#### CompanySelector
**Arquivo**: `src/components/company/CompanySelector.tsx`

**Features**:
- Dropdown com lista de empresas
- Exibir nome fantasia ou raz√£o social
- Mostrar CNPJ formatado
- Badge "Padr√£o" para empresa default
- Bot√£o para adicionar nova empresa

#### CompanyDialog
**Arquivo**: `src/components/company/CompanyDialog.tsx`

**Features**:
- Formul√°rio completo de empresa
- Valida√ß√£o de CNPJ em tempo real
- Formata√ß√£o autom√°tica de campos
- Consulta √† API da Receita Federal (opcional)
- Modo criar/editar

**Campos do Formul√°rio**:
- CNPJ (obrigat√≥rio, com valida√ß√£o)
- Raz√£o Social (obrigat√≥rio)
- Nome Fantasia
- Inscri√ß√£o Estadual
- Inscri√ß√£o Municipal
- Endere√ßo completo
- Dados de contato
- Porte da empresa
- Regime tribut√°rio
- Dados banc√°rios padr√£o

#### CompanyCard
**Arquivo**: `src/components/company/CompanyCard.tsx`

**Features**:
- Exibir informa√ß√µes resumidas da empresa
- A√ß√µes r√°pidas (editar, excluir, tornar padr√£o)
- Indicadores visuais de status
- M√©tricas b√°sicas (saldo, transa√ß√µes)

### 4. P√°ginas

#### CompaniesPage
**Arquivo**: `src/pages/companies/CompaniesPage.tsx`

**Layout**:
- Grid de cards de empresas
- Bot√£o de adicionar empresa
- Filtros e busca
- Estat√≠sticas gerais

#### ConsolidatedDashboard
**Arquivo**: `src/pages/dashboard/ConsolidatedDashboard.tsx`

**Se√ß√µes**:
1. **Cards de Resumo Geral**
   - Saldo total (todas as empresas)
   - Receitas totais
   - Despesas totais
   - Lucro l√≠quido

2. **Tabs de Visualiza√ß√£o**
   - Compara√ß√£o: Gr√°fico de barras comparando receitas/despesas
   - Distribui√ß√£o: Pizza mostrando distribui√ß√£o de saldos
   - Performance: Margem de lucro por empresa
   - Evolu√ß√£o: Linha temporal de crescimento

3. **Filtros**
   - Sele√ß√£o de empresas
   - Per√≠odo de an√°lise
   - Categorias espec√≠ficas

#### MultiCompanyReport
**Arquivo**: `src/components/reports/MultiCompanyReport.tsx`

**Features**:
- Sele√ß√£o m√∫ltipla de empresas
- Filtro por per√≠odo
- Agrega√ß√£o de dados
- Exporta√ß√£o para PDF/Excel
- Gr√°ficos comparativos
- Tabela consolidada

### 5. Utilit√°rios

**Arquivo**: `src/utils/validators.ts`

```typescript
export const validateCNPJ = (cnpj: string): boolean => {
  // Implementa√ß√£o completa de valida√ß√£o de CNPJ
};

export const formatCNPJ = (value: string): string => {
  // Formatar como 00.000.000/0000-00
};

export const validateCPF = (cpf: string): boolean => {
  // Valida√ß√£o de CPF
};

export const formatCPF = (value: string): string => {
  // Formatar como 000.000.000-00
};
```

**Arquivo**: `src/utils/cnpjApi.ts`

```typescript
export const consultarCNPJ = async (cnpj: string): Promise<CompanyData> => {
  // Consultar API da Receita Federal
  // Retornar dados estruturados
};
```

### 6. Services

**Arquivo**: `src/services/companyService.ts`

```typescript
export const companyService = {
  async getAll(): Promise<Company[]> {
    // Buscar todas as empresas do usu√°rio
  },
  
  async getById(id: string): Promise<Company> {
    // Buscar empresa espec√≠fica
  },
  
  async create(data: CreateCompanyDTO): Promise<Company> {
    // Criar nova empresa
  },
  
  async update(id: string, data: UpdateCompanyDTO): Promise<Company> {
    // Atualizar empresa
  },
  
  async delete(id: string): Promise<void> {
    // Soft delete (is_active = false)
  },
  
  async setDefault(id: string): Promise<void> {
    // Definir como empresa padr√£o
  },
};
```

### 7. Types

**Arquivo**: `src/types/company.ts`

```typescript
export interface Company {
  id: string;
  user_id: string;
  cnpj: string;
  razao_social: string;
  nome_fantasia?: string;
  inscricao_estadual?: string;
  inscricao_municipal?: string;
  
  // Endere√ßo
  cep?: string;
  logradouro?: string;
  numero?: string;
  complemento?: string;
  bairro?: string;
  cidade?: string;
  uf?: string;
  
  // Contato
  email?: string;
  phone?: string;
  website?: string;
  
  // Classifica√ß√£o
  porte?: 'MEI' | 'ME' | 'EPP' | 'MEDIA' | 'GRANDE';
  regime_tributario?: 'SIMPLES' | 'LUCRO_PRESUMIDO' | 'LUCRO_REAL';
  
  // Dados Banc√°rios
  banco_padrao?: string;
  agencia_padrao?: string;
  conta_padrao?: string;
  
  // Status
  is_active: boolean;
  is_default: boolean;
  
  // Configura√ß√µes
  settings?: Record<string, any>;
  
  // Timestamps
  created_at: string;
  updated_at: string;
}

export interface CreateCompanyDTO {
  cnpj: string;
  razao_social: string;
  nome_fantasia?: string;
  // ... outros campos opcionais
}

export interface UpdateCompanyDTO {
  razao_social?: string;
  nome_fantasia?: string;
  // ... campos edit√°veis
}
```

---

## üîÑ ADAPTA√á√ïES EM COMPONENTES EXISTENTES

### Componentes que Precisam Ser Adaptados

#### 1. TransactionForm
**Mudan√ßas**:
- Adicionar seletor de empresa (se PJ)
- Filtrar contas banc√°rias pela empresa selecionada
- Filtrar categorias pela empresa selecionada

#### 2. BankAccountForm
**Mudan√ßas**:
- Adicionar campo company_id
- Exibir apenas se conta PJ
- Validar que a empresa pertence ao usu√°rio

#### 3. CategoryForm
**Mudan√ßas**:
- Adicionar campo company_id
- Permitir criar categorias espec√≠ficas por empresa
- Manter categorias globais do usu√°rio

#### 4. Dashboard (Principal)
**Mudan√ßas**:
- Adicionar toggle PF/PJ
- Se PJ, mostrar seletor de empresa
- Filtrar todos os dados pela empresa selecionada
- Adicionar link para dashboard consolidado

#### 5. TransactionsList
**Mudan√ßas**:
- Adicionar coluna de empresa (se visualiza√ß√£o consolidada)
- Filtros adicionais por empresa
- Agrupamento por empresa (opcional)

#### 6. Reports
**Mudan√ßas**:
- Adicionar op√ß√£o de relat√≥rio multi-empresa
- Filtros de empresa
- Comparativos entre empresas

---

## üöÄ PLANO DE IMPLEMENTA√á√ÉO PASSO A PASSO

### FASE 1: Prepara√ß√£o (Dias 1-3)

**Dia 1: Setup**
```bash
# Criar branch de feature
git checkout -b feature/pj-accounts

# Instalar depend√™ncias se necess√°rio
npm install

# Preparar ambiente de desenvolvimento
```

**Dia 2-3: Banco de Dados**
1. Criar arquivo de migration: `supabase/migrations/YYYYMMDD_add_pj_support.sql`
2. Implementar todas as tabelas e altera√ß√µes
3. Criar functions de valida√ß√£o
4. Implementar RLS policies
5. Criar views consolidadas
6. Adicionar √≠ndices
7. Testar migration em ambiente local

**Checklist Banco de Dados**:
- [ ] Tabela account_types criada
- [ ] Tabela companies criada
- [ ] Tabelas existentes estendidas com company_id
- [ ] RLS habilitado em todas as tabelas
- [ ] Policies criadas e testadas
- [ ] Function validate_cnpj criada
- [ ] Function validate_cpf criada
- [ ] Function calculate_account_balance adaptada
- [ ] Triggers de auditoria criados
- [ ] Views consolidadas criadas
- [ ] √çndices criados
- [ ] Migration testada com rollback

### FASE 2: Types e Utilit√°rios (Dias 4-5)

**Dia 4: Types**
```typescript
// src/types/company.ts
// src/types/accountType.ts
// Atualizar src/types/transaction.ts
// Atualizar src/types/bankAccount.ts
// Atualizar src/types/category.ts
```

**Dia 5: Utilit√°rios**
```typescript
// src/utils/validators.ts - Valida√ß√µes de CNPJ/CPF
// src/utils/formatters.ts - Formata√ß√µes
// src/utils/cnpjApi.ts - Consulta √† Receita Federal (opcional)
```

**Checklist Types e Utilit√°rios**:
- [ ] Interface Company definida
- [ ] DTOs de Company definidos
- [ ] Types existentes atualizados
- [ ] validateCNPJ implementado e testado
- [ ] validateCPF implementado e testado
- [ ] formatCNPJ implementado
- [ ] formatCPF implementado
- [ ] Testes unit√°rios de valida√ß√µes

### FASE 3: Services e Context (Dias 6-8)

**Dia 6: Company Service**
```typescript
// src/services/companyService.ts
// Implementar todas as opera√ß√µes CRUD
// Adicionar tratamento de erros
// Implementar cache se necess√°rio
```

**Dia 7-8: Context API**
```typescript
// src/context/CompanyContext.tsx
// Implementar provider
// Criar hook useCompany
// Integrar com localStorage
// Implementar Realtime subscriptions (opcional)
```

**Checklist Services e Context**:
- [ ] companyService.getAll implementado
- [ ] companyService.getById implementado
- [ ] companyService.create implementado
- [ ] companyService.update implementado
- [ ] companyService.delete implementado
- [ ] companyService.setDefault implementado
- [ ] CompanyProvider implementado
- [ ] useCompany hook criado
- [ ] Integra√ß√£o com localStorage
- [ ] Tratamento de erros
- [ ] Loading states

### FASE 4: Componentes Base (Dias 9-12)

**Dia 9: CompanySelector**
```typescript
// src/components/company/CompanySelector.tsx
// Dropdown de sele√ß√£o
// Integra√ß√£o com Context
// Styling com shadcn/ui
```

**Dia 10: CompanyDialog**
```typescript
// src/components/company/CompanyDialog.tsx
// Formul√°rio completo
// Valida√ß√µes em tempo real
// Modo criar/editar
// Consulta CNPJ (opcional)
```

**Dia 11: CompanyCard**
```typescript
// src/components/company/CompanyCard.tsx
// Exibi√ß√£o de dados
// A√ß√µes r√°pidas
// Indicadores visuais
```

**Dia 12: Componentes Auxiliares**
```typescript
// src/components/company/CompanyBadge.tsx
// src/components/company/CompanyAvatar.tsx
// src/components/forms/CNPJInput.tsx
```

**Checklist Componentes Base**:
- [ ] CompanySelector funcionando
- [ ] CompanyDialog - modo criar
- [ ] CompanyDialog - modo editar
- [ ] CompanyCard criado
- [ ] Valida√ß√µes de formul√°rio
- [ ] Formata√ß√£o autom√°tica de CNPJ
- [ ] Feedback visual de erros
- [ ] Responsividade mobile
- [ ] Acessibilidade (a11y)

### FASE 5: P√°ginas Principais (Dias 13-16)

**Dia 13-14: CompaniesPage**
```typescript
// src/pages/companies/CompaniesPage.tsx
// Lista de empresas em grid
// Funcionalidade de busca
// Filtros
// Estat√≠sticas gerais
```

**Dia 15-16: Adaptar Dashboard**
```typescript
// src/pages/dashboard/Dashboard.tsx
// Adicionar seletor de empresa para PJ
// Filtrar dados pela empresa selecionada
// Toggle PF/PJ
// Integrar CompanySelector
```

**Checklist P√°ginas Principais**:
- [ ] CompaniesPage - layout grid
- [ ] CompaniesPage - busca
- [ ] CompaniesPage - filtros
- [ ] CompaniesPage - estat√≠sticas
- [ ] Dashboard - seletor de empresa
- [ ] Dashboard - filtro por empresa
- [ ] Dashboard - toggle PF/PJ
- [ ] Navega√ß√£o entre p√°ginas
- [ ] Breadcrumbs atualizados

### FASE 6: Dashboard Consolidado (Dias 17-20)

**Dia 17-18: ConsolidatedDashboard**
```typescript
// src/pages/dashboard/ConsolidatedDashboard.tsx
// Cards de resumo geral
// Gr√°ficos comparativos
// Filtros multi-empresa
```

**Dia 19-20: Gr√°ficos e Visualiza√ß√µes**
```typescript
// Implementar gr√°ficos com Recharts
// Gr√°fico de barras comparativo
// Gr√°fico de pizza de distribui√ß√£o
// Gr√°fico de linhas de evolu√ß√£o
```

**Checklist Dashboard Consolidado**:
- [ ] Cards de resumo implementados
- [ ] Gr√°fico de compara√ß√£o
- [ ] Gr√°fico de distribui√ß√£o
- [ ] Gr√°fico de performance
- [ ] Filtros de empresa
- [ ] Filtros de per√≠odo
- [ ] C√°lculos de m√©tricas
- [ ] Formata√ß√£o de valores
- [ ] Loading states
- [ ] Empty states

### FASE 7: Relat√≥rios Multi-Empresa (Dias 21-23)

**Dia 21-22: MultiCompanyReport**
```typescript
// src/components/reports/MultiCompanyReport.tsx
// Sele√ß√£o de empresas
// Agrega√ß√£o de dados
// Tabela consolidada
```

**Dia 23: Exporta√ß√µes**
```typescript
// src/utils/export.ts
// Exportar para PDF
// Exportar para Excel
// Exportar para CSV
```

**Checklist Relat√≥rios**:
- [ ] Sele√ß√£o m√∫ltipla de empresas
- [ ] Agrega√ß√£o de transa√ß√µes
- [ ] Tabela consolidada
- [ ] Totalizadores
- [ ] Exporta√ß√£o PDF
- [ ] Exporta√ß√£o Excel
- [ ] Exporta√ß√£o CSV
- [ ] Gr√°ficos no relat√≥rio

### FASE 8: Adapta√ß√µes em Componentes Existentes (Dias 24-27)

**Dia 24: TransactionForm**
```typescript
// src/components/forms/TransactionForm.tsx
// Adicionar seletor de empresa
// Filtrar contas por empresa
// Filtrar categorias por empresa
```

**Dia 25: BankAccountForm**
```typescript
// src/components/forms/BankAccountForm.tsx
// Adicionar campo company_id
// Valida√ß√µes espec√≠ficas
```

**Dia 26: CategoryForm**
```typescript
// src/components/forms/CategoryForm.tsx
// Adicionar campo company_id
// Permitir categorias por empresa
```

**Dia 27: TransactionsList**
```typescript
// src/components/transactions/TransactionsList.tsx
// Adicionar coluna de empresa
// Filtros por empresa
// Agrupamento por empresa
```

**Checklist Adapta√ß√µes**:
- [ ] TransactionForm adaptado
- [ ] BankAccountForm adaptado
- [ ] CategoryForm adaptado
- [ ] TransactionsList adaptado
- [ ] Filtros funcionando
- [ ] Valida√ß√µes corretas
- [ ] Sem regress√µes em PF

### FASE 9: Hooks Customizados (Dias 28-29)

**Dia 28: useMultiCompanyFilter**
```typescript
// src/hooks/useMultiCompanyFilter.ts
// Gerenciar filtros multi-empresa
// Builder de queries Supabase
```

**Dia 29: Outros Hooks**
```typescript
// src/hooks/useCompanyMetrics.ts
// src/hooks/useCompanyTransactions.ts
// src/hooks/useCompanyAccounts.ts
```

**Checklist Hooks**:
- [ ] useMultiCompanyFilter implementado
- [ ] useCompanyMetrics implementado
- [ ] useCompanyTransactions implementado
- [ ] useCompanyAccounts implementado
- [ ] Memoiza√ß√£o otimizada
- [ ] Tratamento de erros

### FASE 10: Testes (Dias 30-35)

**Dia 30-31: Testes Unit√°rios**
```bash
# Testar valida√ß√µes
# Testar utilit√°rios
# Testar services
# Testar hooks
```

**Dia 32-33: Testes de Integra√ß√£o**
```bash
# Testar fluxos completos
# Testar integra√ß√µes com Supabase
# Testar RLS policies
```

**Dia 34-35: Testes E2E**
```bash
# Testar fluxo de cria√ß√£o de empresa
# Testar fluxo de transa√ß√£o PJ
# Testar dashboard consolidado
# Testar relat√≥rios
```

**Checklist Testes**:
- [ ] Testes unit√°rios de validators
- [ ] Testes de companyService
- [ ] Testes de hooks
- [ ] Testes de componentes
- [ ] Testes de integra√ß√£o
- [ ] Testes de RLS
- [ ] Testes E2E principais
- [ ] Cobertura > 80%

### FASE 11: Migra√ß√£o de Dados (Dias 36-38)

**Dia 36: Preparar Script de Migra√ß√£o**
```sql
-- Script para migrar dados PF existentes
-- Manter integridade referencial
-- Rollback plan
```

**Dia 37: Executar Migra√ß√£o em Staging**
```bash
# Backup completo
# Executar migration
# Validar dados
# Testes de smoke
```

**Dia 38: Valida√ß√£o**
```bash
# Verificar integridade dos dados
# Validar RLS
# Testar performance
```

**Checklist Migra√ß√£o**:
- [ ] Script de migra√ß√£o criado
- [ ] Backup realizado
- [ ] Migration executada
- [ ] Dados validados
- [ ] RLS testado
- [ ] Performance ok
- [ ] Rollback plan testado

### FASE 12: Documenta√ß√£o (Dias 39-40)

**Dia 39: Documenta√ß√£o T√©cnica**
```markdown
# Criar README.md da feature
# Documentar API
# Documentar banco de dados
# Diagramas de arquitetura
```

**Dia 40: Guia do Usu√°rio**
```markdown
# Como criar empresa
# Como gerenciar empresas
# Como usar dashboard consolidado
# Como gerar relat√≥rios
```

**Checklist Documenta√ß√£o**:
- [ ] README da feature
- [ ] Documenta√ß√£o de API
- [ ] Documenta√ß√£o do banco
- [ ] Diagramas atualizados
- [ ] Guia do usu√°rio
- [ ] FAQ
- [ ] Release notes

### FASE 13: Deploy (Dias 41-42)

**Dia 41: Prepara√ß√£o para Deploy**
```bash
# Code review
# Merge da branch
# Build de produ√ß√£o
# Preparar rollback plan
```

**Dia 42: Deploy e Monitoramento**
```bash
# Deploy em staging
# Testes finais
# Deploy em produ√ß√£o
# Monitoramento intensivo
```

**Checklist Deploy**:
- [ ] Code review conclu√≠do
- [ ] Branch merged
- [ ] Build sem erros
- [ ] Deploy em staging ok
- [ ] Testes finais ok
- [ ] Deploy em produ√ß√£o ok
- [ ] Monitoramento ativo
- [ ] Hotfix plan pronto

---

## ‚úÖ CHECKLIST FINAL DE VALIDA√á√ÉO

### Funcionalidades Core
- [ ] Usu√°rio pode criar m√∫ltiplas empresas
- [ ] CNPJ √© validado corretamente
- [ ] Dados de PF e PJ s√£o completamente isolados
- [ ] Dados entre empresas PJ s√£o isolados
- [ ] Empresa padr√£o √© selecionada automaticamente
- [ ] Dashboard mostra dados da empresa selecionada
- [ ] Dashboard consolidado agrega todas as empresas
- [ ] Transa√ß√µes s√£o criadas com company_id correto
- [ ] Contas banc√°rias pertencem √†s empresas corretas
- [ ] Categorias podem ser por empresa ou globais

### Seguran√ßa
- [ ] RLS est√° habilitado em todas as tabelas
- [ ] Usu√°rio s√≥ v√™ suas pr√≥prias empresas
- [ ] Usu√°rio s√≥ v√™ dados de suas empresas
- [ ] N√£o h√° vazamento de dados entre usu√°rios
- [ ] N√£o h√° vazamento de dados entre empresas
- [ ] Valida√ß√µes funcionam no backend
- [ ] Auditoria registra todas as opera√ß√µes

### Performance
- [ ] Dashboard carrega em < 2s
- [ ] Queries com √≠ndices otimizados
- [ ] Pagina√ß√£o implementada onde necess√°rio
- [ ] Lazy loading de componentes
- [ ] Memoiza√ß√£o otimizada
- [ ] Bundle size aceit√°vel

### UX/UI
- [ ] Interface intuitiva
- [ ] Feedback visual adequado
- [ ] Loading states em todas as a√ß√µes
- [ ] Mensagens de erro claras
- [ ] Confirma√ß√µes de a√ß√µes destrutivas
- [ ] Responsivo mobile
- [ ] Acessibilidade (a11y)

### Qualidade de C√≥digo
- [ ] ESLint sem erros
- [ ] TypeScript sem erros
- [ ] C√≥digo comentado onde necess√°rio
- [ ] Naming conventions consistentes
- [ ] Arquitetura limpa
- [ ] Princ√≠pios SOLID seguidos

### Testes
- [ ] Testes unit√°rios passando
- [ ] Testes de integra√ß√£o passando
- [ ] Testes E2E passando
- [ ] Cobertura de testes > 80%
- [ ] Edge cases testados

### Documenta√ß√£o
- [ ] README atualizado
- [ ] Documenta√ß√£o de API
- [ ] Guia do usu√°rio
- [ ] Coment√°rios no c√≥digo
- [ ] Changelog atualizado

---

## üéØ CRIT√âRIOS DE SUCESSO

### T√©cnicos
1. ‚úÖ 100% de isolamento de dados entre PF e PJ
2. ‚úÖ 100% de isolamento de dados entre empresas PJ
3. ‚úÖ Valida√ß√£o de CNPJ com 100% de precis√£o
4. ‚úÖ Performance: Dashboard < 2s de carregamento
5. ‚úÖ Sem quebras em funcionalidades PF existentes
6. ‚úÖ Cobertura de testes > 80%

### Funcionais
1. ‚úÖ Usu√°rio pode gerenciar at√© 50 empresas
2. ‚úÖ Dashboard consolidado funciona com todas as empresas
3. ‚úÖ Relat√≥rios agregam dados de m√∫ltiplas empresas
4. ‚úÖ Exporta√ß√£o de relat√≥rios funcionando
5. ‚úÖ Mobile responsivo

### Neg√≥cio
1. ‚úÖ Sistema pronto para produ√ß√£o
2. ‚úÖ Documenta√ß√£o completa
3. ‚úÖ Treinamento de usu√°rios preparado
4. ‚úÖ Suporte preparado para d√∫vidas

---

## üîß COMANDOS √öTEIS

### Desenvolvimento
```bash
# Iniciar servidor de desenvolvimento
npm run dev

# Build de produ√ß√£o
npm run build

# Executar testes
npm run test

# Executar testes com cobertura
npm run test:coverage

# Lint
npm run lint

# Formatar c√≥digo
npm run format
```

### Supabase
```bash
# Rodar migrations
supabase db push

# Gerar types TypeScript
supabase gen types typescript --local > src/types/supabase.ts

# Resetar database local
supabase db reset

# Ver logs
supabase functions logs
```

### Git
```bash
# Criar branch de feature
git checkout -b feature/pj-accounts

# Commit com mensagem sem√¢ntica
git commit -m "feat: add company management system"

# Push da branch
git push origin feature/pj-accounts

# Criar Pull Request
gh pr create --title "feat: Add PJ Account Support" --body "..."
```

---

## üìö RECURSOS E REFER√äNCIAS

### Documenta√ß√£o Oficial
- [Supabase RLS](https://supabase.com/docs/guides/auth/row-level-security)
- [PostgreSQL Row Security](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)
- [React Context](https://react.dev/reference/react/useContext)
- [shadcn/ui](https://ui.shadcn.com/)
- [Recharts](https://recharts.org/)

### Valida√ß√£o de CNPJ
- [Algoritmo de Valida√ß√£o](https://www.geradorcnpj.com/algoritmo_do_cnpj.htm)
- [Receita Federal API](https://receitaws.com.br/api)

### Best Practices
- [Multi-tenancy Patterns](https://docs.aws.amazon.com/whitepapers/latest/saas-architecture-fundamentals/multi-tenancy-models.html)
- [React Best Practices](https://react.dev/learn)
- [TypeScript Do's and Don'ts](https://www.typescriptlang.org/docs/handbook/declaration-files/do-s-and-don-ts.html)

---

## üö® PONTOS DE ATEN√á√ÉO

### CR√çTICOS
1. **Isolamento de Dados**: Testar exaustivamente RLS
2. **Valida√ß√£o de CNPJ**: N√£o confiar apenas no frontend
3. **Performance**: Monitorar queries complexas
4. **Migra√ß√£o**: Ter plano de rollback sempre pronto
5. **Auditoria**: N√£o esquecer de logar opera√ß√µes cr√≠ticas

### IMPORTANTES
1. Manter compatibilidade com contas PF
2. N√£o quebrar funcionalidades existentes
3. Garantir UX consistente
4. Documentar todas as mudan√ßas
5. Comunicar breaking changes

### OPCIONAIS (Mas Recomendados)
1. Integra√ß√£o com API da Receita Federal
2. Realtime updates com Supabase
3. Cache de dados para performance
4. PWA para funcionar offline
5. Exporta√ß√£o avan√ßada de relat√≥rios

---

## üéì PADR√ïES DE C√ìDIGO

### Naming Conventions
```typescript
// Componentes: PascalCase
export function CompanySelector() {}

// Hooks: camelCase com prefixo 'use'
export function useCompany() {}

// Services: camelCase com sufixo 'Service'
export const companyService = {}

// Constants: UPPER_SNAKE_CASE
export const MAX_COMPANIES_PER_USER = 50;

// Types/Interfaces: PascalCase
export interface Company {}
```

### Estrutura de Arquivos
```
src/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ company/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CompanySelector.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CompanyDialog.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CompanyCard.tsx
‚îÇ   ‚îî‚îÄ‚îÄ forms/
‚îÇ       ‚îî‚îÄ‚îÄ CNPJInput.tsx
‚îú‚îÄ‚îÄ context/
‚îÇ   ‚îî‚îÄ‚îÄ CompanyContext.tsx
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ useCompany.ts
‚îÇ   ‚îî‚îÄ‚îÄ useMultiCompanyFilter.ts
‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îú‚îÄ‚îÄ companies/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CompaniesPage.tsx
‚îÇ   ‚îî‚îÄ‚îÄ dashboard/
‚îÇ       ‚îî‚îÄ‚îÄ ConsolidatedDashboard.tsx
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ companyService.ts
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îú‚îÄ‚îÄ company.ts
‚îÇ   ‚îî‚îÄ‚îÄ supabase.ts
‚îî‚îÄ‚îÄ utils/
    ‚îú‚îÄ‚îÄ validators.ts
    ‚îî‚îÄ‚îÄ formatters.ts
```

### Coment√°rios
```typescript
/**
 * Valida um CNPJ usando o algoritmo oficial da Receita Federal.
 * 
 * @param cnpj - CNPJ a ser validado (com ou sem formata√ß√£o)
 * @returns true se o CNPJ √© v√°lido, false caso contr√°rio
 * 
 * @example
 * validateCNPJ('12.345.678/0001-90') // true
 * validateCNPJ('00000000000000') // false
 */
export function validateCNPJ(cnpj: string): boolean {
  // Implementa√ß√£o
}
```

---

## üéØ PR√ìXIMOS PASSOS AP√ìS IMPLEMENTA√á√ÉO

### Curto Prazo (1-2 meses)
1. Coletar feedback dos usu√°rios
2. Ajustar UX com base no uso real
3. Otimizar queries lentas
4. Adicionar m√©tricas de uso
5. Implementar melhorias sugeridas

### M√©dio Prazo (3-6 meses)
1. Integra√ß√£o com Receita Federal
2. Importa√ß√£o de NFe
3. Concilia√ß√£o banc√°ria autom√°tica
4. BI avan√ßado com IA
5. App mobile nativo

### Longo Prazo (6-12 meses)
1. Multi-user (permiss√µes por empresa)
2. API p√∫blica
3. Integra√ß√µes com ERPs
4. M√≥dulo de folha de pagamento
5. M√≥dulo fiscal completo

---

**FIM DO PROMPT MASTER**

Este documento deve servir como guia completo para a implementa√ß√£o do sistema de contas PJ no OnliFin. Siga cada etapa com aten√ß√£o, validando constantemente o isolamento de dados e a seguran√ßa do sistema.

Boa implementa√ß√£o! üöÄ
