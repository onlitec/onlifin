version: '3.8'

# üöÄ Docker Compose para Coolify - Onlifin Multi-Container
# Configura√ß√£o otimizada para deploy no Coolify

services:
  # üì± Aplica√ß√£o Onlifin com API
  onlifin-app:
    image: onlitec/onlifin:api
    restart: unless-stopped
    
    environment:
      # Aplica√ß√£o
      APP_NAME: "Onlifin"
      APP_ENV: production
      APP_DEBUG: "false"
      APP_URL: "${APP_URL}"
      APP_KEY: "${APP_KEY}"
      
      # Banco de dados MySQL
      DB_CONNECTION: mysql
      DB_HOST: onlifin-db
      DB_PORT: 3306
      DB_DATABASE: onlifin_production
      DB_USERNAME: onlifin_user
      DB_PASSWORD: "${DB_PASSWORD}"
      
      # Cache e sess√µes Redis
      CACHE_DRIVER: redis
      SESSION_DRIVER: redis
      QUEUE_CONNECTION: redis
      REDIS_HOST: onlifin-redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: "${REDIS_PASSWORD}"
      
      # Configura√ß√µes da API
      SANCTUM_STATEFUL_DOMAINS: "${SANCTUM_DOMAINS}"
      SESSION_DOMAIN: "${SESSION_DOMAIN}"
      API_RATE_LIMIT: 60
      API_RATE_LIMIT_UNAUTHENTICATED: 10
      
      # CORS para app Android
      CORS_ALLOWED_ORIGINS: "*"
      CORS_ALLOWED_METHODS: "GET,POST,PUT,DELETE,OPTIONS"
      CORS_ALLOWED_HEADERS: "Content-Type,Authorization,X-Requested-With,Accept,Origin"
      
      # IA
      GROQ_API_KEY: "${GROQ_API_KEY}"
      GROQ_MODEL: "llama3-8b-8192"
      
      # Email (opcional)
      MAIL_MAILER: smtp
      MAIL_HOST: "${MAIL_HOST}"
      MAIL_PORT: "${MAIL_PORT}"
      MAIL_USERNAME: "${MAIL_USERNAME}"
      MAIL_PASSWORD: "${MAIL_PASSWORD}"
      MAIL_ENCRYPTION: tls
      MAIL_FROM_ADDRESS: "${MAIL_FROM_ADDRESS}"
      MAIL_FROM_NAME: "Onlifin"
      
      # Timezone
      APP_TIMEZONE: "America/Sao_Paulo"
      APP_LOCALE: "pt_BR"
    
    volumes:
      - onlifin_storage:/var/www/html/storage
      - onlifin_uploads:/var/www/html/public/uploads
    
    depends_on:
      - onlifin-db
      - onlifin-redis
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/api/docs"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    labels:
      # Labels para Coolify
      - "coolify.managed=true"
      - "coolify.version=1.0"
      - "coolify.type=application"

  # üóÑÔ∏è Banco de dados MySQL
  onlifin-db:
    image: mysql:8.0
    restart: unless-stopped
    
    environment:
      MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD}"
      MYSQL_DATABASE: onlifin_production
      MYSQL_USER: onlifin_user
      MYSQL_PASSWORD: "${DB_PASSWORD}"
      MYSQL_CHARSET: utf8mb4
      MYSQL_COLLATION: utf8mb4_unicode_ci
    
    volumes:
      - onlifin_mysql_data:/var/lib/mysql
    
    command: --default-authentication-plugin=mysql_native_password --innodb-buffer-pool-size=256M
    
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 30s
      timeout: 10s
      retries: 3
    
    labels:
      - "coolify.managed=true"
      - "coolify.type=database"

  # üî¥ Redis para cache e sess√µes
  onlifin-redis:
    image: redis:7-alpine
    restart: unless-stopped
    
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD} --maxmemory 256mb --maxmemory-policy allkeys-lru
    
    volumes:
      - onlifin_redis_data:/data
    
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    
    labels:
      - "coolify.managed=true"
      - "coolify.type=cache"

# üìÅ Volumes persistentes
volumes:
  onlifin_storage:
    driver: local
  onlifin_uploads:
    driver: local
  onlifin_mysql_data:
    driver: local
  onlifin_redis_data:
    driver: local
